<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <style>
    body,
    .navbar,
    .navbar-brand,
    .navbar-nav .nav-link {
      font-family: 'Space Grotesk', 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      letter-spacing: 0.02em;
    }
    .navbar-nav .nav-link {
      font-weight: 500;
    }
    .navbar-brand {
      font-weight: 600;
      text-transform: uppercase;
    }
  </style>

  <!-- ========================================================= -->
  <!--     1. TARGET PAGE PARAMS (MUST LOAD BEFORE at.js)         -->
  <!-- ========================================================= -->
  <% if (crmid) { %>
  <script>
    window.targetPageParams = function () {
      console.log("Target thirdPartyId set:", "<%= crmid %>");

      return {
        id: {
          thirdPartyId: "<%= crmid %>"
        },
        profile: {
          age: 32,
          country: "Thailand"
        }
      };
    };
  </script>
  <% } %>

  <!-- ========================================================= -->
  <!--     2. ECID SERVICE (Visitor API)                         -->
  <!-- ========================================================= -->
  <script src="/js/visitorAPI.js"></script>

  <script>
    var visitor = Visitor.getInstance("F9FF22D36909027D0A495FCA@AdobeOrg", {
      trackingServer: "",
      trackingServerSecure: ""
    });
  </script>

  <% if (crmid) { %>
  <!-- AUTHENTICATED USER -->
  <script>
    visitor.setCustomerIDs({
      crmid: {
        id: "<%= crmid %>",
        authState: Visitor.AuthState.AUTHENTICATED
      }
    });

    console.log("ECID Set: AUTHENTICATED → CRMID =", "<%= crmid %>");
  </script>

  <% } else if (justLoggedOut) { %>
  <!-- LOGGED OUT USER -->
  <script>
    visitor.setCustomerIDs({
      crmid: {
        id: "<%= crmid %>",
        authState: Visitor.AuthState.LOGGED_OUT
      }
    });

    console.log("ECID Set: LOGGED_OUT → CRMID =", "<%= crmid %>");
  </script>
  <% } %>

  <!-- ========================================================= -->
  <!--     3. ADOBE TARGET 2.x (at.js) – MUST LOAD LAST          -->
  <!-- ========================================================= -->
  <script src="/js/at.js"></script>

</head>

<body>

  <!-- NAVBAR -->
  <%- include('partials/navbar') %>

  <!-- MAIN CONTENT -->
  <div class="container mt-4">
    <%- body %>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
